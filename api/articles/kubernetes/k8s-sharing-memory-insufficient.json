{"title":"K8S Pod 中共享内存不足问题","uid":"0e025b15fb575a54a8fc4bbc222e5a27","slug":"kubernetes/k8s-sharing-memory-insufficient","date":"2025-02-15T06:48:51.000Z","updated":"2025-02-15T06:51:26.813Z","comments":true,"path":"api/articles/kubernetes/k8s-sharing-memory-insufficient.json","keywords":"宋国磊, glmapper, 卫恒, 分享, 开源","cover":null,"content":"<p>报错信息大致如下：</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>RuntimeError: Insufficient shared memory available. Required: 452984832, Available: 60555264. The required memory can’t exceed 80% of the available shared memory, it’s recommended to reduce memory usage by following methods:  1. reduce value of parameter max_rowsize or num_parallel_workers. 2. reduce prefetch size by set_prefetch_size(). 3. disable shared memory by set_enable_shared_mem().</p></blockquote>\n<p>Kubernetes 分配给容器的共享内存不足。尽管你的机器总内存足够，但容器本身只能使用一部分内存作为共享内存，导致共享内存不足的错误。</p>\n<span id=\"more\"></span>\n<ul>\n<li><strong>共享内存的限制</strong>：容器的共享内存有一个限制，通常是 <code>/dev/shm</code> 的大小。默认情况下，Docker 和 Kubernetes 会为容器分配一个较小的共享内存大小，通常是 64MB 或 128MB。</li>\n</ul>\n<h2 id=\"增加容器的共享内存大小\"><a href=\"#增加容器的共享内存大小\" class=\"headerlink\" title=\"增加容器的共享内存大小\"></a>增加容器的共享内存大小</h2><p>通过 Kubernetes 设置容器的共享内存大小。要增加容器的共享内存，可以在 YAML 配置文件中添加 <code>emptyDir</code> 类型的共享内存卷，或者通过 <code>--shm-size</code> 来设置容器的共享内存大小。</p>\n<h3 id=\"通过-emptyDir-卷设置共享内存\"><a href=\"#通过-emptyDir-卷设置共享内存\" class=\"headerlink\" title=\"通过 emptyDir 卷设置共享内存\"></a>通过 <code>emptyDir</code> 卷设置共享内存</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">batch/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Job</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">tolov5-train-job</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">tolov5-container</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">tolov5_npu</span></span><br><span class=\"line\">          <span class=\"attr\">command:</span> [<span class=\"string\">&quot;/bin/bash&quot;</span>, <span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;python3 /mnt/data/train.py&quot;</span>]</span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/mnt/data</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">training-volume</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/dev/shm</span> <span class=\"comment\"># 这里映射到容器</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">shm-volume</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Never</span></span><br><span class=\"line\">  <span class=\"attr\">backoffLimit:</span> <span class=\"number\">4</span></span><br><span class=\"line\">  <span class=\"attr\">volumes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">training-volume</span></span><br><span class=\"line\">      <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/path/on/host/to/training_data</span></span><br><span class=\"line\">        <span class=\"attr\">type:</span> <span class=\"string\">Directory</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">shm-volume</span></span><br><span class=\"line\">      <span class=\"attr\">emptyDir:</span></span><br><span class=\"line\">        <span class=\"attr\">medium:</span> <span class=\"string\">Memory</span>  <span class=\"comment\"># 使用内存作为存储，表示共享内存</span></span><br><span class=\"line\">        <span class=\"attr\">sizeLimit:</span> <span class=\"string\">256Gi</span>  <span class=\"comment\"># 设置共享内存大小为 256GB</span></span><br></pre></td></tr></table></figure>\n\n<p>在上面的配置中：</p>\n<ul>\n<li><code>emptyDir.medium: Memory</code> 表示将 <code>emptyDir</code> 卷挂载到容器的 <code>/dev/shm</code> 目录，这样就相当于将容器的共享内存配置为使用内存而非磁盘。</li>\n<li><code>sizeLimit: 256Gi</code> 设置共享内存的大小为 256GB，确保容器在运行时有足够的共享内存来满足需求。</li>\n</ul>\n<h3 id=\"通过-Docker-的-shm-size-设置共享内存\"><a href=\"#通过-Docker-的-shm-size-设置共享内存\" class=\"headerlink\" title=\"通过 Docker 的 --shm-size 设置共享内存\"></a>通过 Docker 的 <code>--shm-size</code> 设置共享内存</h3><p>如果你是使用 Docker 或 Kubernetes 启动容器，你还可以通过 <code>--shm-size</code> 参数直接设置共享内存的大小。如果使用 <code>kubectl</code> 命令直接启动 Pod，可以添加如下参数来设置共享内存大小：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">run</span> <span class=\"string\">my-job</span> <span class=\"string\">--image=tolov5_npu</span> <span class=\"string\">--overrides=&#x27;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;apiVersion&quot;:</span> <span class=\"string\">&quot;v1&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;spec&quot;:</span> &#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;containers&quot;:</span> [</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;name&quot;:</span> <span class=\"string\">&quot;tolov5-container&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;image&quot;:</span> <span class=\"string\">&quot;tolov5_npu&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;resources&quot;:</span> &#123;</span><br><span class=\"line\">          <span class=\"attr\">&quot;requests&quot;:</span> &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;memory&quot;:</span> <span class=\"string\">&quot;256Gi&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"attr\">&quot;command&quot;:</span> [<span class=\"string\">&quot;/bin/bash&quot;</span>, <span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;python3 /mnt/data/train.py&quot;</span>],</span><br><span class=\"line\">        <span class=\"attr\">&quot;volumeMounts&quot;:</span> [</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;mountPath&quot;:</span> <span class=\"string\">&quot;/mnt/data&quot;</span>,</span><br><span class=\"line\">            <span class=\"attr\">&quot;name&quot;:</span> <span class=\"string\">&quot;training-volume&quot;</span></span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;mountPath&quot;:</span> <span class=\"string\">&quot;/dev/shm&quot;</span>,</span><br><span class=\"line\">            <span class=\"attr\">&quot;name&quot;:</span> <span class=\"string\">&quot;shm-volume&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"attr\">&quot;volumes&quot;:</span> [</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;name&quot;:</span> <span class=\"string\">&quot;shm-volume&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;emptyDir&quot;:</span> &#123;</span><br><span class=\"line\">          <span class=\"attr\">&quot;medium&quot;:</span> <span class=\"string\">&quot;Memory&quot;</span>,</span><br><span class=\"line\">          <span class=\"attr\">&quot;sizeLimit&quot;:</span> <span class=\"string\">&quot;256Gi&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br></pre></td></tr></table></figure>\n\n<p>这将为容器分配一个 256GB 的共享内存。</p>\n<h2 id=\"减少内存使用量\"><a href=\"#减少内存使用量\" class=\"headerlink\" title=\"减少内存使用量\"></a>减少内存使用量</h2><p>错误信息中提到了几个可以减少内存占用的方法，尤其是对于内存密集型任务（如深度学习训练任务），你可以尝试以下操作：</p>\n<ul>\n<li><strong>减少 <code>max_rowsize</code> 或 <code>num_parallel_workers</code> 参数的值</strong>：这些参数通常与模型训练过程中的数据加载有关，减少它们可以减小内存占用。</li>\n<li><strong>调整 <code>prefetch_size</code> 参数</strong>：减少 <code>prefetch_size</code> 可以减少一次性加载的数据量，从而降低内存需求。</li>\n<li><strong>禁用共享内存</strong>：如果可能的话，可以禁用共享内存（通过 <code>set_enable_shared_mem()</code>），不过这会影响性能。</li>\n</ul>\n<p>你可以尝试在启动脚本 <code>train.py</code> 中或模型的配置中调整这些参数。</p>\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><h3 id=\"调整容器的内存请求和限制\"><a href=\"#调整容器的内存请求和限制\" class=\"headerlink\" title=\"调整容器的内存请求和限制\"></a><strong>调整容器的内存请求和限制</strong></h3><p>如果你只设置了内存的请求值，并且没有为容器设置 <code>limits</code>，Kubernetes 可能会根据实际资源情况进行调整。你可以通过设置内存请求和限制来确保容器得到足够的内存资源。</p>\n<p>示例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">resources:</span><br><span class=\"line\">  requests:</span><br><span class=\"line\">    memory: &quot;256Gi&quot;  # 容器初始请求的内存</span><br><span class=\"line\">  limits:</span><br><span class=\"line\">    memory: &quot;256Gi&quot;  # 容器最大允许使用的内存</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"检查宿主机的共享内存配置\"><a href=\"#检查宿主机的共享内存配置\" class=\"headerlink\" title=\"检查宿主机的共享内存配置\"></a>检查宿主机的共享内存配置</h3><p>如果容器的共享内存依赖于宿主机的 <code>/dev/shm</code>，确保宿主机的共享内存足够大。你可以通过以下命令查看宿主机的共享内存大小：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">df -h /dev/shm</span><br></pre></td></tr></table></figure>\n\n<p>如果宿主机的共享内存不足，可以通过修改宿主机的配置文件增加共享内存的大小。</p>\n","feature":true,"text":"报错信息大致如下： RuntimeError: Insufficient shared memory available. Required: 45298483...","permalink":"/post/kubernetes/k8s-sharing-memory-insufficient","photos":[],"count_time":{"symbolsCount":"3.7k","symbolsTime":"3 mins."},"categories":[{"name":"kubernetes","slug":"kubernetes","count":3,"path":"api/categories/kubernetes.json"}],"tags":[{"name":"kubernetes","slug":"kubernetes","count":4,"path":"api/tags/kubernetes.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%A2%9E%E5%8A%A0%E5%AE%B9%E5%99%A8%E7%9A%84%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F\"><span class=\"toc-text\">增加容器的共享内存大小</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%80%9A%E8%BF%87-emptyDir-%E5%8D%B7%E8%AE%BE%E7%BD%AE%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98\"><span class=\"toc-text\">通过 emptyDir 卷设置共享内存</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%80%9A%E8%BF%87-Docker-%E7%9A%84-shm-size-%E8%AE%BE%E7%BD%AE%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98\"><span class=\"toc-text\">通过 Docker 的 --shm-size 设置共享内存</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%87%8F%E5%B0%91%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E9%87%8F\"><span class=\"toc-text\">减少内存使用量</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%85%B6%E4%BB%96\"><span class=\"toc-text\">其他</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%B0%83%E6%95%B4%E5%AE%B9%E5%99%A8%E7%9A%84%E5%86%85%E5%AD%98%E8%AF%B7%E6%B1%82%E5%92%8C%E9%99%90%E5%88%B6\"><span class=\"toc-text\">调整容器的内存请求和限制</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%A3%80%E6%9F%A5%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%9A%84%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">检查宿主机的共享内存配置</span></a></li></ol></li></ol>","author":{"name":"glmapper","slug":"blog-author","avatar":"https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/common/favicon.ico","link":"/","description":"开放，开源，分享，共享","socials":{"github":"https://github.com/glmapper","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/2412872703","zhihu":"","csdn":"","juejin":"https://juejin.cn/user/3227821827961806","customs":{"sofastack":{"icon":"https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/common/sofastack.svg","link":"https://www.sofastack.tech/"}}}},"mapped":true,"hidden":false,"prev_post":{},"next_post":{"title":"k8s-rational-of-scheduler","uid":"278b3ce51ecfe81c1855a9665e3a6c3d","slug":"kubernetes/k8s-rational-of-scheduler","date":"2025-02-15T06:47:46.000Z","updated":"2025-02-15T06:51:23.414Z","comments":true,"path":"api/articles/kubernetes/k8s-rational-of-scheduler.json","keywords":"宋国磊, glmapper, 卫恒, 分享, 开源","cover":[],"text":"k8s scheduler 的主要职责是为新创建的 pod 寻找一个最合适的 node 节点, 然后进行 bind node 绑定, 后面 kubelet 才会...","permalink":"/post/kubernetes/k8s-rational-of-scheduler","photos":[],"count_time":{"symbolsCount":"7.4k","symbolsTime":"7 mins."},"categories":[{"name":"kubernetes","slug":"kubernetes","count":3,"path":"api/categories/kubernetes.json"}],"tags":[{"name":"kubernetes","slug":"kubernetes","count":4,"path":"api/tags/kubernetes.json"}],"author":{"name":"glmapper","slug":"blog-author","avatar":"https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/common/favicon.ico","link":"/","description":"开放，开源，分享，共享","socials":{"github":"https://github.com/glmapper","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/2412872703","zhihu":"","csdn":"","juejin":"https://juejin.cn/user/3227821827961806","customs":{"sofastack":{"icon":"https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/common/sofastack.svg","link":"https://www.sofastack.tech/"}}}},"feature":true}}
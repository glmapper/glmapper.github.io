{"title":"创建用于 sdk 访问 api server 的 token","uid":"5acf42da29ded0f7849afc371d3fe51f","slug":"kubernetes/k8s-create-api-token","date":"2025-02-15T06:47:08.000Z","updated":"2025-02-15T06:53:06.833Z","comments":true,"path":"api/articles/kubernetes/k8s-create-api-token.json","keywords":"宋国磊, glmapper, 卫恒, 分享, 开源","cover":null,"content":"<p>在 Kubernetes 中，可以通过创建一个服务账户（ServiceAccount）并为其生成一个 token 来访问 Kubernetes API Server。</p>\n<p>默认情况下，Kubernetes 中的 <strong>ServiceAccount</strong> 仅限于访问它所在的命名空间（namespace）内的资源。如果你创建的 <code>ServiceAccount</code> 位于 <code>default</code> 命名空间，它的权限默认只会覆盖 <code>default</code> 命名空间中的资源。</p>\n<span id=\"more\"></span>\n<p>Kubernetes 中的 <strong>RBAC (Role-Based Access Control)</strong> 是基于角色和角色绑定来控制访问权限的。<code>ServiceAccount</code> 本身并没有权限，必须通过绑定 <code>Role</code> 或 <code>ClusterRole</code> 来授予权限。根据你的需要，你可以选择授予它对单个命名空间的权限（通过 <code>Role</code> 和 <code>RoleBinding</code>），或者授予对集群范围内资源的权限（通过 <code>ClusterRole</code> 和 <code>ClusterRoleBinding</code>）。当你创建一个 <code>ServiceAccount</code> 时，除非你显式地为它配置了角色和角色绑定，它是没有任何权限的。因此，如果你没有为它分配 <code>Role</code> 或 <code>ClusterRole</code>，它不能访问任何命名空间内的资源。即使它在 <code>default</code> 命名空间，除非显式授权，它也无法访问其他命名空间的资源。</p>\n<h2 id=\"授予跨命名空间访问权限\"><a href=\"#授予跨命名空间访问权限\" class=\"headerlink\" title=\"授予跨命名空间访问权限\"></a>授予跨命名空间访问权限</h2><p>如果你希望该 <code>ServiceAccount</code> 能访问其他命名空间的资源，你可以为它创建适当的 <code>Role</code> 和 <code>RoleBinding</code>，或者使用 <code>ClusterRole</code> 和 <code>ClusterRoleBinding</code> 来授予跨命名空间或集群范围的访问权限。</p>\n<h2 id=\"创建\"><a href=\"#创建\" class=\"headerlink\" title=\"创建\"></a>创建</h2><p>为了访问 Kubernetes 集群的所有资源，您需要为某个 <strong>ServiceAccount</strong> 授予 <strong>集群级别的权限</strong>。这通常通过创建一个 <code>ClusterRole</code> 和一个 <code>ClusterRoleBinding</code> 来完成，并将该角色绑定到您的 <code>ServiceAccount</code>。一旦角色和角色绑定完成，您就可以生成一个访问所有资源的 <code>Token</code>。</p>\n<h3 id=\"创建-ServiceAccount\"><a href=\"#创建-ServiceAccount\" class=\"headerlink\" title=\"创建 ServiceAccount\"></a>创建 ServiceAccount</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">api-token-service-account</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"创建-ClusterRole\"><a href=\"#创建-ClusterRole\" class=\"headerlink\" title=\"创建 ClusterRole\"></a>创建 ClusterRole</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">api-token-cluster-role</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"comment\"># 允许对所有 API 组、所有资源和所有操作进行访问</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;apps&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;batch&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;extensions&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;rbac.authorization.k8s.io&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;authorization.k8s.io&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;networking.k8s.io&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;storage.k8s.io&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;coordination.k8s.io&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;admission.k8s.io&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;*&quot;</span>]</span><br><span class=\"line\">  <span class=\"comment\"># 更多的 apiGroups 和资源可以按需添加</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"创建-cluster-role-binding\"><a href=\"#创建-cluster-role-binding\" class=\"headerlink\" title=\"创建 cluster-role-binding\"></a>创建 cluster-role-binding</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">api-token-cluster-role-bind</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">api-token-service-account</span></span><br><span class=\"line\">    <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">api-token-cluster-role</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建-token\"><a href=\"#创建-token\" class=\"headerlink\" title=\"创建 token\"></a>创建 token</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get secret $(kubectl get serviceaccount api-token-service-account -o jsonpath=&#x27;&#123;.secrets[0].name&#125;&#x27;) -o jsonpath=&#x27;&#123;.data.token&#125;&#x27; | base64 --decode</span><br></pre></td></tr></table></figure>\n\n<p>执行完成之后会生成一个 token，可以用这个 token 来访问 api server。</p>\n<h3 id=\"创建-ApiClient\"><a href=\"#创建-ApiClient\" class=\"headerlink\" title=\"创建 ApiClient\"></a>创建 ApiClient</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ApiClient <span class=\"title function_\">buildClient</span><span class=\"params\">(String apiServer, String token)</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">ApiClient</span> <span class=\"variable\">apiClient</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ClientBuilder</span>().setBasePath(apiServer).setVerifyingSsl(<span class=\"literal\">false</span>)</span><br><span class=\"line\">            .setAuthentication(<span class=\"keyword\">new</span> <span class=\"title class_\">AccessTokenAuthentication</span>(token)).build();</span><br><span class=\"line\">    Configuration.setDefaultApiClient(apiClient);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> apiClient;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>AppsV1Api</strong>：用于管理 Kubernetes 应用程序的 API 对象，如 Deployment、StatefulSet、DaemonSet 和 ReplicaSet 等。、</li>\n<li><strong>BatchV1Api</strong>：用于管理 Kubernetes 批处理作业的 API 对象，如 Job 和 CronJob 等。</li>\n<li><strong>CoreV1Api</strong>：用于管理 Kubernetes 核心 API 对象，如 Pod、Service、Namespace、Node 和 PersistentVolume 等。</li>\n</ul>\n","feature":true,"text":"在 Kubernetes 中，可以通过创建一个服务账户（ServiceAccount）并为其生成一个 token 来访问 Kubernetes API Serv...","permalink":"/post/kubernetes/k8s-create-api-token","photos":[],"count_time":{"symbolsCount":"3.4k","symbolsTime":"3 mins."},"categories":[{"name":"kubernetes","slug":"kubernetes","count":3,"path":"api/categories/kubernetes.json"}],"tags":[{"name":"kubernetes","slug":"kubernetes","count":4,"path":"api/tags/kubernetes.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%8E%88%E4%BA%88%E8%B7%A8%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90\"><span class=\"toc-text\">授予跨命名空间访问权限</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BA\"><span class=\"toc-text\">创建</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BA-ServiceAccount\"><span class=\"toc-text\">创建 ServiceAccount</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BA-ClusterRole\"><span class=\"toc-text\">创建 ClusterRole</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BA-cluster-role-binding\"><span class=\"toc-text\">创建 cluster-role-binding</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BA-token\"><span class=\"toc-text\">创建 token</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BA-ApiClient\"><span class=\"toc-text\">创建 ApiClient</span></a></li></ol></li></ol>","author":{"name":"glmapper","slug":"blog-author","avatar":"https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/common/favicon.ico","link":"/","description":"开放，开源，分享，共享","socials":{"github":"https://github.com/glmapper","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/2412872703","zhihu":"","csdn":"","juejin":"https://juejin.cn/user/3227821827961806","customs":{"sofastack":{"icon":"https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/common/sofastack.svg","link":"https://www.sofastack.tech/"}}}},"mapped":true,"hidden":false,"prev_post":{"title":"K8S 核心调度器的实现原理","uid":"fdbd0dbddaaaaaef4ce4630f6b679a59","slug":"kubernetes/k8s-rational-of-scheduler","date":"2025-02-15T06:47:46.000Z","updated":"2025-02-15T06:53:20.740Z","comments":true,"path":"api/articles/kubernetes/k8s-rational-of-scheduler.json","keywords":"宋国磊, glmapper, 卫恒, 分享, 开源","cover":[],"text":"k8s scheduler 的主要职责是为新创建的 pod 寻找一个最合适的 node 节点, 然后进行 bind node 绑定, 后面 kubelet 才会...","permalink":"/post/kubernetes/k8s-rational-of-scheduler","photos":[],"count_time":{"symbolsCount":"7.4k","symbolsTime":"7 mins."},"categories":[{"name":"kubernetes","slug":"kubernetes","count":3,"path":"api/categories/kubernetes.json"}],"tags":[{"name":"kubernetes","slug":"kubernetes","count":4,"path":"api/tags/kubernetes.json"}],"author":{"name":"glmapper","slug":"blog-author","avatar":"https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/common/favicon.ico","link":"/","description":"开放，开源，分享，共享","socials":{"github":"https://github.com/glmapper","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/2412872703","zhihu":"","csdn":"","juejin":"https://juejin.cn/user/3227821827961806","customs":{"sofastack":{"icon":"https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/common/sofastack.svg","link":"https://www.sofastack.tech/"}}}},"feature":true},"next_post":{"title":"探寻 Unix Domain Socket：本地进程通信的高效之选","uid":"203b222208cfb32777fef4a2e1c6bb3c","slug":"network/unix-domain-socket","date":"2025-02-15T06:05:30.000Z","updated":"2025-02-15T06:06:36.708Z","comments":true,"path":"api/articles/network/unix-domain-socket.json","keywords":"宋国磊, glmapper, 卫恒, 分享, 开源","cover":null,"text":"在计算机系统的复杂架构中，不同进程间的通信（Inter-Process Communication，IPC）犹如连接各个功能模块的桥梁，是实现系统协同运作的关键...","permalink":"/post/network/unix-domain-socket","photos":[],"count_time":{"symbolsCount":"8.7k","symbolsTime":"8 mins."},"categories":[{"name":"network","slug":"network","count":1,"path":"api/categories/network.json"}],"tags":[{"name":"unix","slug":"unix","count":1,"path":"api/tags/unix.json"},{"name":"socket","slug":"socket","count":1,"path":"api/tags/socket.json"}],"author":{"name":"glmapper","slug":"blog-author","avatar":"https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/common/favicon.ico","link":"/","description":"开放，开源，分享，共享","socials":{"github":"https://github.com/glmapper","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/2412872703","zhihu":"","csdn":"","juejin":"https://juejin.cn/user/3227821827961806","customs":{"sofastack":{"icon":"https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/common/sofastack.svg","link":"https://www.sofastack.tech/"}}}}}}
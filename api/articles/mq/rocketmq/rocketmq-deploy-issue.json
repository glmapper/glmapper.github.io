{"title":"RocketMQ 本地部署问题总结","uid":"8c745d5436d89ed91d5d8624c45dc15a","slug":"mq/rocketmq/rocketmq-deploy-issue","date":"2022-09-22T13:29:02.000Z","updated":"2024-07-05T04:09:05.794Z","comments":true,"path":"api/articles/mq/rocketmq/rocketmq-deploy-issue.json","keywords":null,"cover":[],"content":"<p>本篇分为 RocketMQ 部署和 RocketMQ-dashboard 部署两部分，主要是 RocketMQ 部署问题较多，汇总了下网上各路大神以及官方 issue 的讨论汇总而来。</p>\n<h2 id=\"RocketMQ-部署\"><a href=\"#RocketMQ-部署\" class=\"headerlink\" title=\"RocketMQ 部署\"></a>RocketMQ 部署</h2><p>根据官方的<a href=\"https://rocketmq.apache.org/docs/%E4%BB%8B%E7%BB%8D/02quickstart\">快速开始</a> 尝试在本地部署 RocketMQ；如果你是按照官方文档直接来搞，可能 90% 是不可能成功的。</p>\n<span id=\"more\"></span>\n\n<p>我自己本地部署时遇到了绝大多数网上都遇到的问题（从 4.2.0 到 4.9.3 版本均无法直接启动），比如：</p>\n<ul>\n<li>No route info of this topic</li>\n<li>connect to [127.0.0.1:9876] failed</li>\n<li>org.apache.rocketmq.client.exception.MQBrokerException: CODE: 14</li>\n</ul>\n<h3 id=\"No-route-info-of-this-topic\"><a href=\"#No-route-info-of-this-topic\" class=\"headerlink\" title=\"No route info of this topic\"></a>No route info of this topic</h3><p>这里在官方 issue 上有讨论，而且很激烈 ：<a href=\"https://github.com/apache/rocketmq/issues/504\">https://github.com/apache/rocketmq/issues/504</a>；RocketMQ 作为 Apache 顶级项目，在 issue 中还会对 qiuck starter 有如此激烈的讨论和吐槽，是否也应该有一些反思？即使是有问题出现，也应该将详细的信息吐出来，不管是没有连接到 NameServer 还是 缺少 Topic，都应该将信息暴露给用户。从我部署来看，出现 <code>No route info of this topic</code>时，先通过手动创建了 Topic，没有解决。尝试看了下代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">private SendResult sendDefaultImpl(</span><br><span class=\"line\">    Message msg,</span><br><span class=\"line\">    final CommunicationMode communicationMode,</span><br><span class=\"line\">    final SendCallback sendCallback,</span><br><span class=\"line\">    final long timeout</span><br><span class=\"line\">) throws MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</span><br><span class=\"line\">    // 省略...</span><br><span class=\"line\">    // 这里取到的 topicPublishInfo 里面的 messageQueue 为 空，导致 topicPublishInfo.ok 为 false</span><br><span class=\"line\">    TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic());</span><br><span class=\"line\">    if (topicPublishInfo != null &amp;&amp; topicPublishInfo.ok()) &#123;</span><br><span class=\"line\">        boolean callTimeout = false;</span><br><span class=\"line\">        // 省略...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // 省略...</span><br><span class=\"line\">    throw new MQClientException(&quot;No route info of this topic: &quot; + msg.getTopic() + FAQUrl.suggestTodo(FAQUrl.NO_TOPIC_ROUTE_INFO),</span><br><span class=\"line\">                                null).setResponseCode(ClientErrorCode.NOT_FOUND_TOPIC_EXCEPTION);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>从 debug 分析来看，topicPublishInfo 里面的 messageQueue 是空的；NameServer 和 Broker 进程也都是正常的，原因在于配置存在问题，导致 NameServer 和 Broker 没有建立正常的连接关系，从而导致 NameServer 感知不到 Broker，所以拉不到信息。</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>因为是本地部署，并且部署 rocketmq-dashboard 确可以正常连接到集群，都可以看到 Topic 信息；所以基本排除了防火墙、内外网不通等问题干；网上有很多类似的解题思路，各位仁兄在参考时一定要结合自己的实际情况来看，不要一股脑扎进去配置。</p></blockquote>\n<h3 id=\"connect-to-127-0-0-1-9876-failed\"><a href=\"#connect-to-127-0-0-1-9876-failed\" class=\"headerlink\" title=\"connect to [127.0.0.1:9876] failed\"></a>connect to [127.0.0.1:9876] failed</h3><p>这个问题也是有些莫名奇妙的，NameServer 是正常启动的，通过 telnet localhost 9876 端口也是正常的，但是官方 demo 启动时报了这个错。从网上摸索了下，得到的解决方案是：</p>\n<p>1、不要使用官方文档的启动命令，使用如下命令代替：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sh bin/mqbroker -n localhost:9876 -c conf/broker.conf</span><br></pre></td></tr></table></figure>\n\n<p>2、broker.conf 配置文件中增加了如下配置</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">namesrvAddr = localhost:9876</span><br><span class=\"line\">brokerIP1=localhost</span><br><span class=\"line\">brokerIP2=localhost</span><br></pre></td></tr></table></figure>\n\n<p>重启启动 Broker 即可。</p>\n<h3 id=\"MQBrokerException-CODE-14\"><a href=\"#MQBrokerException-CODE-14\" class=\"headerlink\" title=\"MQBrokerException: CODE: 14\"></a>MQBrokerException: CODE: 14</h3><p>这个异常信息给的比较靠谱：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Caused by CODE: 14 DESC: service not available now, maybe disk full</span><br></pre></td></tr></table></figure>\n\n<p>通过异常可以非常明确的 get 到原因，就是磁盘空间不够了。我本地 mac 磁盘空间从剩余 10G ，清理到剩余 50G 之后，重新启动客户端 OK 了。</p>\n<h2 id=\"RocketMQ-Dashboard-部署\"><a href=\"#RocketMQ-Dashboard-部署\" class=\"headerlink\" title=\"RocketMQ-Dashboard 部署\"></a>RocketMQ-Dashboard 部署</h2><p>这个项目还是有点惊喜的，<a href=\"https://github.com/apache/rocketmq-dashboard/\">https://github.com/apache/rocketmq-dashboard/</a> 。</p>\n<p>部署可以参考：<a href=\"https://rocketmq.apache.org/docs/%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%BF%90%E7%BB%B4/17Dashboard\">https://rocketmq.apache.org/docs/%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%BF%90%E7%BB%B4/17Dashboard</a> ；这个部署比较简单，没有 RocketMQ 那么多套路和问题，部署完成之后，界面大致如下：</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c3ca0d3c6cf47f2a728d238057dcb16~tplv-k3u1fbpfcp-zoom-1.image\"></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>如果图片链接无法展示，可以查阅原文：<a href=\"https://juejin.cn/post/7143906476229132318\">https://juejin.cn/post/7143906476229132318</a></p></blockquote>\n","text":"本篇分为 RocketMQ 部署和 RocketMQ-dashboard 部署两部分，主要是 RocketMQ 部署问题较多，汇总了下网上各路大神以及官方 is...","permalink":"/post/mq/rocketmq/rocketmq-deploy-issue","photos":[],"count_time":{"symbolsCount":"2.6k","symbolsTime":"2 mins."},"categories":[{"name":"RocketMQ","slug":"RocketMQ","count":2,"path":"api/categories/RocketMQ.json"}],"tags":[{"name":"RocketMQ","slug":"RocketMQ","count":3,"path":"api/tags/RocketMQ.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#RocketMQ-%E9%83%A8%E7%BD%B2\"><span class=\"toc-text\">RocketMQ 部署</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#No-route-info-of-this-topic\"><span class=\"toc-text\">No route info of this topic</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#connect-to-127-0-0-1-9876-failed\"><span class=\"toc-text\">connect to [127.0.0.1:9876] failed</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#MQBrokerException-CODE-14\"><span class=\"toc-text\">MQBrokerException: CODE: 14</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#RocketMQ-Dashboard-%E9%83%A8%E7%BD%B2\"><span class=\"toc-text\">RocketMQ-Dashboard 部署</span></a></li></ol>","author":{"name":"glmapper","slug":"blog-author","avatar":"https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/common/favicon.ico","link":"/","description":"开放，开源，分享，共享","socials":{"github":"https://github.com/glmapper","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/2412872703","zhihu":"","csdn":"","juejin":"https://juejin.cn/user/3227821827961806","customs":{"sofastack":{"icon":"https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/common/sofastack.svg","link":"https://www.sofastack.tech/"}}}},"mapped":true,"hidden":false,"prev_post":{"title":"RocketMQ Push 消费模型","uid":"58f683d88937558e07ea2c785aa7588a","slug":"mq/rocketmq/rocketmq-push-consumer-model","date":"2022-09-22T13:31:29.000Z","updated":"2024-07-05T04:09:05.794Z","comments":true,"path":"api/articles/mq/rocketmq/rocketmq-push-consumer-model.json","keywords":null,"cover":[],"text":"Push 模式是指由 Server 端来控制消息的推送，即当有消息到 Server 之后，会将消息主动投递给 client(Consumer 端)。 使用 De...","permalink":"/post/mq/rocketmq/rocketmq-push-consumer-model","photos":[],"count_time":{"symbolsCount":"9.6k","symbolsTime":"9 mins."},"categories":[{"name":"RocketMQ","slug":"RocketMQ","count":2,"path":"api/categories/RocketMQ.json"}],"tags":[{"name":"RocketMQ","slug":"RocketMQ","count":3,"path":"api/tags/RocketMQ.json"}],"author":{"name":"glmapper","slug":"blog-author","avatar":"https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/common/favicon.ico","link":"/","description":"开放，开源，分享，共享","socials":{"github":"https://github.com/glmapper","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/2412872703","zhihu":"","csdn":"","juejin":"https://juejin.cn/user/3227821827961806","customs":{"sofastack":{"icon":"https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/common/sofastack.svg","link":"https://www.sofastack.tech/"}}}}},"next_post":{"title":"ab 测试","uid":"c87a3afb2738074b526bbfc99d4f6216","slug":"tests/test-benchmark-ab","date":"2022-09-22T13:26:42.000Z","updated":"2024-07-05T04:09:05.844Z","comments":true,"path":"api/articles/tests/test-benchmark-ab.json","keywords":null,"cover":null,"text":"Apache Benchmark Tool ab is a tool for benchmarking your Apache Hypertext Transf...","permalink":"/post/tests/test-benchmark-ab","photos":[],"count_time":{"symbolsCount":"10k","symbolsTime":"9 mins."},"categories":[{"name":"test","slug":"test","count":5,"path":"api/categories/test.json"}],"tags":[{"name":"test","slug":"test","count":5,"path":"api/tags/test.json"},{"name":"ab test","slug":"ab-test","count":1,"path":"api/tags/ab-test.json"}],"author":{"name":"glmapper","slug":"blog-author","avatar":"https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/common/favicon.ico","link":"/","description":"开放，开源，分享，共享","socials":{"github":"https://github.com/glmapper","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/2412872703","zhihu":"","csdn":"","juejin":"https://juejin.cn/user/3227821827961806","customs":{"sofastack":{"icon":"https://glmapper-blog.oss-cn-hangzhou.aliyuncs.com/common/sofastack.svg","link":"https://www.sofastack.tech/"}}}}}}